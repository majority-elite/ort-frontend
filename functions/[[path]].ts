import {
  createWorkersKVSessionStorage,
  createCookie,
} from '@remix-run/cloudflare';
import { createPagesFunctionHandler } from '@remix-run/cloudflare-pages';
import type {
  AuthSessionData,
  AuthSessionStorage,
} from '@/constants/types/auth';
import type { Env } from '@/constants/types/env';

// eslint-disable-next-line @typescript-eslint/ban-ts-comment
// @ts-ignore - the server build file is generated by `remix vite:build`
// eslint-disable-next-line import/no-unresolved, import/order
import * as build from '../build/server';

export const onRequest = createPagesFunctionHandler<Env>({
  build,
  getLoadContext: ({
    context,
  }): Env & { authSessionStorage: AuthSessionStorage } => {
    const sessionCookie = createCookie('__auth_session', {
      secrets: [context.cloudflare.env.AUTH_COOKIE_SESSION_SECRET],
      sameSite: true,
    });
    const authSessionStorage = createWorkersKVSessionStorage<AuthSessionData>({
      cookie: sessionCookie,
      kv: context.cloudflare.env.KV_NAMESPACE,
    });
    return {
      ...context.cloudflare.env,
      authSessionStorage,
    };
  },
});
